{% extends "base.html" %}

{% block headcontent %}

    <title>Processing index</title>

{% endblock %} 


{% block content %}

   <div class="bold-text">Stage</div>
   <div id="stage">
      {% if stage %}
         <div">{{ stage }}</div>
      {% endif %}
   </div>
   <hr class="custom-hr">

   <div class="bold-text">Activity log</div>
   <div id="status">
      {% if status %}
         <div>{{ status }}</div>
      {% endif %}
   </div>
   <hr class="custom-hr">

   <a id="cost" href="">Potential cost of access to cloud-deployed LLMs</a>
   <hr class="custom-hr">

   <form action="{% url 'indexer:index' %}" method="get">
      <input type="submit" name="Back" class="submitbutton" value="Back">
   </form>



   <script>
      window.setTimeout(getData, 3000);

      async function getData() {
         try {
            const response = await fetch("../status/", {
               headers:{
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
               },
            });
            if (!response.ok) {
               throw new Error(`Response status: ${response.status}`);
            }
            const result = await response.json();
            try {
               document.getElementById('stage').innerHTML = result["stage"]
            } catch (error) {
               console.error(error.message);
            }
            try {
               document.getElementById('status').innerHTML = ""
               for (const value of result["status"]) {
                  document.getElementById('status').innerHTML += "<br>" + value
               }
            } catch (error) {
               console.error(error.message);
            }

            var anchorCost = document.getElementById('cost');
            anchorCost.href = '../results?totalrequests=' + result["llmrequests"] + "&totalinputtokens=" + result["llminputtokens"] + "&totaloutputtokens=" + result["llmoutputtokens"];
            anchorCost.target = '_blank';

            const stages = ["error", "completed"]
            if (!stages.includes(result["stage"]))  {
               setTimeout(getData, 3000);
            }
         } catch (error) {
            console.error(error.message);
         }
      }
   </script>


{% endblock %} 
